{% extends "base.html" %}

{% block title %}Food Locker Management - TS Management Services Pte Ltd{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="bg-white rounded-4 shadow-sm p-4 border-0" style="border-left: 5px solid var(--primary-color) !important;">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div class="mb-3 mb-lg-0">
                    <h1 class="h2 mb-2 text-dark fw-bold d-flex align-items-center">
                        <div class="bg-primary rounded-circle p-3 me-3 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                            <i class="fas fa-utensils text-white fs-5"></i>
                        </div>
                        Food Locker Management
                    </h1>
                    <p class="text-secondary mb-0 fs-6 ms-5 ps-2">Manage food locker rentals, caterer assignments, and room allocations</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary rounded-pill px-4 py-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#addFoodLockerModal">
                        <i class="fas fa-plus me-2"></i>
                        Add Food Locker
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtering Controls -->
<div class="row mb-4">
    <div class="col-12">
        <div class="bg-white rounded-4 shadow-sm border-0">
            <div class="p-4">
                <h5 class="mb-4 text-dark fw-semibold d-flex align-items-center">
                    <div class="bg-info rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width: 35px; height: 35px;">
                        <i class="fas fa-filter text-white fs-6"></i>
                    </div>
                    Filter Options
                </h5>
                <form method="GET" class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <label for="start_date" class="form-label text-dark fw-medium mb-2">Start Date</label>
                        <input type="date" class="form-control rounded-3 py-2 px-3" id="start_date" name="start_date" 
                               value="{{ start_date or '' }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="end_date" class="form-label text-dark fw-medium mb-2">End Date</label>
                        <input type="date" class="form-control rounded-3 py-2 px-3" id="end_date" name="end_date" 
                               value="{{ end_date or '' }}">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="status" class="form-label text-dark fw-medium mb-2">Status</label>
                        <select class="form-select rounded-3 py-2 px-3" id="status" name="status">
                            <option value="">All Status</option>
                            <option value="Active" {{ 'selected' if status_filter == 'Active' }}>Active</option>
                            <option value="Inactive" {{ 'selected' if status_filter == 'Inactive' }}>Inactive</option>
                            <option value="Pending" {{ 'selected' if status_filter == 'Pending' }}>Pending</option>
                        </select>
                    </div>
                    <div class="col-lg-3 col-md-6 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary rounded-pill px-4 py-2 flex-fill shadow-sm">
                            <i class="fas fa-search me-1"></i>
                            Filter
                        </button>
                        <a href="{{ url_for('food_locker_management') }}" class="btn btn-outline-secondary rounded-pill px-4 py-2 flex-fill">
                            <i class="fas fa-times me-1"></i>
                            Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

    <!-- Food Lockers List -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">
                <i class="fas fa-list me-2"></i>
                Food Locker Records ({{ food_lockers|length }} records)
            </h5>
            <div>
                <button type="button" class="btn btn-sm btn-primary me-2" onclick="bulkEdit()" id="bulkEditBtn" disabled>
                    <i class="fas fa-edit me-1"></i>
                    Edit Selected
                </button>
                <button type="button" class="btn btn-sm btn-danger me-2" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
                    <i class="fas fa-trash me-1"></i>
                    Delete Selected
                </button>
                <button type="button" class="btn btn-sm btn-success me-2" onclick="exportSelected()">
                    <i class="fas fa-file-excel me-1"></i>
                    Export Selected
                </button>
                <button type="button" class="btn btn-sm btn-danger me-2" onclick="exportSelectedPDF()">
                    <i class="fas fa-file-pdf me-1"></i>
                    PDF Selected
                </button>
                <button type="button" class="btn btn-sm btn-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i>
                    Export All
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf me-1"></i>
                    PDF All
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if food_lockers %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleAllSelection()">
                            </th>
                            <th>Company</th>
                            <th>Rental Period</th>
                            <th>Rental Price</th>
                            <th>Caterer</th>
                            <th>Room Numbers</th>
                            <th>Person in Charge</th>
                            <th>Signatures</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for locker in food_lockers %}
                        <tr>
                            <td>
                                <input type="checkbox" class="record-checkbox" value="{{ locker.id }}" onchange="updateBulkButtons()">
                            </td>
                            <td>
                                <strong>{{ locker.company_name }}</strong>
                            </td>
                            <td>
                                {{ locker.rental_start_date.strftime('%Y-%m-%d') }}
                                {% if locker.rental_end_date %}
                                    to {{ locker.rental_end_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                    (Ongoing)
                                {% endif %}
                            </td>
                            <td>
                                <span class="fw-bold text-success">S${{ "%.2f"|format(locker.rental_price) }}</span>
                            </td>
                            <td>
                                <div>
                                    <strong>{{ locker.caterer_name }}</strong><br>
                                    <small class="text-muted">
                                        Driver: {{ locker.driver_name }}<br>
                                        Vehicle: {{ locker.vehicle_plate }}
                                    </small>
                                </div>
                            </td>
                            <td>
                                {% for assignment in locker.room_assignments %}
                                    {% if assignment.is_active %}
                                        <span class="badge bg-info me-1">{{ assignment.room_number.room_number }}</span>
                                    {% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                <div>
                                    <strong>{{ locker.person_in_charge_name }}</strong><br>
                                    <small class="text-muted">
                                        FIN: {{ locker.person_in_charge_fin }}<br>
                                        {% if locker.person_in_charge_phone %}
                                            Phone: {{ locker.person_in_charge_phone }}
                                        {% endif %}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-column">
                                    <small class="text-muted mb-1">Tenant:</small>
                                    {% if locker.tenant_signature %}
                                        <span class="badge bg-success mb-1">
                                            <i class="fas fa-check me-1"></i>Signed
                                        </span>
                                        <small class="text-muted">{{ locker.tenant_signature_date.strftime('%Y-%m-%d %H:%M') if locker.tenant_signature_date }}</small>
                                    {% else %}
                                        <span class="badge bg-warning mb-1">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                    {% endif %}
                                    
                                    <small class="text-muted mb-1 mt-2">OE/DC:</small>
                                    {% if locker.oe_dc_signature %}
                                        <span class="badge bg-success mb-1">
                                            <i class="fas fa-check me-1"></i>Signed
                                        </span>
                                        <small class="text-muted">{{ locker.oe_dc_signature_date.strftime('%Y-%m-%d %H:%M') if locker.oe_dc_signature_date }}</small>
                                    {% else %}
                                        <span class="badge bg-warning mb-1">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <span class="badge 
                                    {% if locker.status == 'Active' %}bg-success
                                    {% elif locker.status == 'Inactive' %}bg-secondary
                                    {% else %}bg-warning
                                    {% endif %}">
                                    {{ locker.status }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="viewFoodLocker({{ locker.id }})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="openSignatureModal({{ locker.id }})">
                                        <i class="fas fa-signature"></i>
                                    </button>
                                    <form method="post" action="{{ url_for('delete_food_locker', food_locker_id=locker.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this food locker record?')">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                <h5>No Food Locker Records</h5>
                <p class="text-muted">No food locker records found. Click "Add Food Locker" to create the first record.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Food Locker Modal -->
<div class="modal fade" id="addFoodLockerModal" tabindex="-1" aria-labelledby="addFoodLockerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFoodLockerModalLabel">Add Food Locker Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('create_food_locker') }}">
                <div class="modal-body">
                    <!-- Company Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-building me-2"></i>Company Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="company_name" class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" id="company_name" name="company_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="rental_price" class="form-label">Rental Price (S$) *</label>
                                    <input type="number" step="0.01" class="form-control" id="rental_price" name="rental_price" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="rental_start_date" class="form-label">Rental Start Date *</label>
                                    <input type="date" class="form-control" id="rental_start_date" name="rental_start_date" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="rental_end_date" class="form-label">Rental End Date</label>
                                    <input type="date" class="form-control" id="rental_end_date" name="rental_end_date">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Caterer Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-truck me-2"></i>Caterer Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="caterer_name" class="form-label">Caterer Name *</label>
                                    <input type="text" class="form-control" id="caterer_name" name="caterer_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="driver_name" class="form-label">Driver Name *</label>
                                    <input type="text" class="form-control" id="driver_name" name="driver_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="driver_phone" class="form-label">Driver Phone</label>
                                    <input type="tel" class="form-control" id="driver_phone" name="driver_phone">
                                </div>
                                <div class="col-md-6">
                                    <label for="vehicle_plate" class="form-label">Vehicle Plate Number *</label>
                                    <input type="text" class="form-control" id="vehicle_plate" name="vehicle_plate" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Room Assignment -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-door-open me-2"></i>Room Assignment</h6>
                        </div>
                        <div class="card-body">
                            <label for="room_numbers" class="form-label">Assigned Room Numbers *</label>
                            <select class="form-select" id="room_numbers" name="room_numbers" multiple required>
                                {% for room in room_numbers %}
                                <option value="{{ room.id }}">{{ room.room_number }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple rooms</small>
                        </div>
                    </div>

                    <!-- Person in Charge -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-user me-2"></i>Person in Charge (Tenant)</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="person_in_charge_fin" class="form-label">FIN Number *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="person_in_charge_fin" name="person_in_charge_fin" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="loadPersonDetails()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Click search to auto-fill from acknowledgment records</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="person_in_charge_name" class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="person_in_charge_name" name="person_in_charge_name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="person_in_charge_phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="person_in_charge_phone" name="person_in_charge_phone">
                                </div>
                                <div class="col-md-6">
                                    <label for="person_in_charge_company" class="form-label">Company</label>
                                    <input type="text" class="form-control" id="person_in_charge_company" name="person_in_charge_company">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- OE/DC Information -->
                    <div class="card mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>OE/DC Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="oe_dc_name" class="form-label">OE/DC Name *</label>
                                    <input type="text" class="form-control" id="oe_dc_name" name="oe_dc_name" value="{{ current_user.first_name }} {{ current_user.last_name }}" required>
                                </div>
                                <div class="col-md-12">
                                    <label for="notes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {% if can_user_create(current_user, 'food_locker') %}
                    <button type="submit" class="btn btn-primary">Create Food Locker Record</button>
                    {% else %}
                    <button class="btn btn-secondary" disabled title="View-only access - cannot create records">
                        <i class="fas fa-eye me-2"></i>View Only
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Food Locker Details Modal -->
<div class="modal fade" id="viewFoodLockerModal" tabindex="-1" aria-labelledby="viewFoodLockerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewFoodLockerModalLabel">Food Locker Details - Record #<span id="viewFoodLockerId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Company Information -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-building me-2"></i>Company Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Company Name:</strong>
                                    <div id="viewCompanyName" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Rental Price:</strong>
                                    <div id="viewRentalPrice" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Rental Period:</strong>
                                    <div id="viewRentalPeriod" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Status:</strong>
                                    <div id="viewStatus" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Caterer Information -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-truck me-2"></i>Caterer Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Caterer Name:</strong>
                                    <div id="viewCatererName" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Driver Name:</strong>
                                    <div id="viewDriverName" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Driver Phone:</strong>
                                    <div id="viewDriverPhone" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Vehicle Plate:</strong>
                                    <div id="viewVehiclePlate" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Person in Charge -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-user me-2"></i>Person in Charge (Tenant)</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Name:</strong>
                                    <div id="viewPersonName" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>FIN Number:</strong>
                                    <div id="viewPersonFin" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Phone:</strong>
                                    <div id="viewPersonPhone" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Company:</strong>
                                    <div id="viewPersonCompany" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Signature Status -->
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-signature me-2"></i>Signature Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Tenant Signature:</strong>
                                    <div id="viewTenantSignature" class="text-muted"></div>
                                    <small id="viewTenantSignatureDate" class="text-muted"></small>
                                </div>
                                <div class="mb-3">
                                    <strong>OE/DC Signature:</strong>
                                    <div id="viewOeDcSignature" class="text-muted"></div>
                                    <small id="viewOeDcSignatureDate" class="text-muted"></small>
                                </div>
                                <div class="mb-3">
                                    <strong>OE/DC Name:</strong>
                                    <div id="viewOeDcName" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Room Assignments -->
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0"><i class="fas fa-home me-2"></i>Room Assignments</h6>
                            </div>
                            <div class="card-body">
                                <div id="viewRoomAssignments" class="text-muted"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-dark text-white">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Notes:</strong>
                                    <div id="viewNotes" class="text-muted"></div>
                                </div>
                                <div class="mb-3">
                                    <strong>Created Date:</strong>
                                    <div id="viewCreatedAt" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- E-Signature Modal -->
<div class="modal fade" id="signatureModal" tabindex="-1" aria-labelledby="signatureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signatureModalLabel">E-Signature</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Tenant Signature</h6>
                        <canvas id="tenantSignatureCanvas" width="300" height="150" style="border: 1px solid #ccc; width: 100%;"></canvas>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature('tenant')">Clear</button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveSignature('tenant')">Save Tenant Signature</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>OE/DC Signature</h6>
                        <canvas id="oeDcSignatureCanvas" width="300" height="150" style="border: 1px solid #ccc; width: 100%;"></canvas>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSignature('oe_dc')">Clear</button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveSignature('oe_dc')">Save OE/DC Signature</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentFoodLockerId = null;
let signaturePads = {};

// Initialize signature pads when modal is shown
document.getElementById('signatureModal').addEventListener('shown.bs.modal', function () {
    if (!signaturePads.tenant) {
        const tenantCanvas = document.getElementById('tenantSignatureCanvas');
        const oeDcCanvas = document.getElementById('oeDcSignatureCanvas');
        
        signaturePads.tenant = new SignaturePad(tenantCanvas);
        signaturePads.oe_dc = new SignaturePad(oeDcCanvas);
        
        // Resize canvas on window resize
        function resizeCanvas(canvas, signaturePad) {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        
        resizeCanvas(tenantCanvas, signaturePads.tenant);
        resizeCanvas(oeDcCanvas, signaturePads.oe_dc);
    }
});

function loadPersonDetails() {
    const finNumber = document.getElementById('person_in_charge_fin').value;
    if (!finNumber) {
        alert('Please enter a FIN number first');
        return;
    }
    
    fetch(`/get-person-details/${finNumber}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('person_in_charge_name').value = data.person.name || '';
                document.getElementById('person_in_charge_phone').value = data.person.phone || '';
                document.getElementById('person_in_charge_company').value = data.person.company || '';
            } else {
                alert('Person not found in acknowledgment records');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading person details');
        });
}

function openSignatureModal(foodLockerId) {
    currentFoodLockerId = foodLockerId;
    const modal = new bootstrap.Modal(document.getElementById('signatureModal'));
    modal.show();
}

function clearSignature(type) {
    if (signaturePads[type]) {
        signaturePads[type].clear();
    }
}

function saveSignature(type) {
    if (!signaturePads[type] || signaturePads[type].isEmpty()) {
        alert('Please provide a signature first');
        return;
    }
    
    const signatureData = signaturePads[type].toDataURL();
    
    const formData = new FormData();
    formData.append('signature_type', type);
    formData.append('signature_data', signatureData);
    
    fetch(`/food-locker/${currentFoodLockerId}/sign`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Signature saved successfully');
            location.reload();
        } else {
            alert('Error saving signature: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving signature');
    });
}

function viewFoodLocker(id) {
    // Add view functionality if needed
    alert('View functionality can be added here');
}

function exportToExcel() {
    const params = new URLSearchParams(window.location.search);
    window.location.href = '/food-locker-management/export/excel?' + params.toString();
}

function exportToPDF() {
    const params = new URLSearchParams(window.location.search);
    window.location.href = '/food-locker-management/export/pdf?' + params.toString();
}

// Bulk operations functions
function toggleAllSelection() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.record-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkButtons();
}

function updateBulkButtons() {
    const checkedBoxes = document.querySelectorAll('.record-checkbox:checked');
    const editBtn = document.getElementById('bulkEditBtn');
    const deleteBtn = document.getElementById('bulkDeleteBtn');
    
    if (checkedBoxes.length > 0) {
        editBtn.disabled = false;
        deleteBtn.disabled = false;
    } else {
        editBtn.disabled = true;
        deleteBtn.disabled = true;
    }
}

function getSelectedIds() {
    const checkboxes = document.querySelectorAll('.record-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function bulkEdit() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('Please select at least one record to edit');
        return;
    }
    
    if (selectedIds.length === 1) {
        editFoodLocker(selectedIds[0]);
    } else {
        alert('Please select only one record to edit');
    }
}

function bulkDelete() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('Please select at least one record to delete');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedIds.length} food locker record(s)?`)) {
        // Create form for bulk delete
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/food-locker-management/bulk-delete';
        
        selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

function exportSelected() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('Please select at least one record to export');
        return;
    }
    
    const params = new URLSearchParams(window.location.search);
    params.append('selected_ids', selectedIds.join(','));
    window.location.href = '/food-locker-management/export/excel?' + params.toString();
}

function exportSelectedPDF() {
    const selectedIds = getSelectedIds();
    if (selectedIds.length === 0) {
        alert('Please select at least one record to export');
        return;
    }
    
    const params = new URLSearchParams(window.location.search);
    params.append('selected_ids', selectedIds.join(','));
    window.location.href = '/food-locker-management/export/pdf?' + params.toString();
}

function viewFoodLocker(id) {
    fetch(`/food-locker/${id}/view`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const locker = data.food_locker;
                
                // Populate modal with data
                document.getElementById('viewFoodLockerId').textContent = locker.id;
                document.getElementById('viewCompanyName').textContent = locker.company_name;
                document.getElementById('viewRentalPrice').textContent = `S$ ${locker.rental_price}`;
                document.getElementById('viewRentalPeriod').textContent = `${locker.rental_start_date} to ${locker.rental_end_date || 'Ongoing'}`;
                document.getElementById('viewCatererName').textContent = locker.caterer_name;
                document.getElementById('viewDriverName').textContent = locker.driver_name;
                document.getElementById('viewDriverPhone').textContent = locker.driver_phone || 'Not provided';
                document.getElementById('viewVehiclePlate').textContent = locker.vehicle_plate;
                document.getElementById('viewPersonName').textContent = locker.person_in_charge_name;
                document.getElementById('viewPersonFin').textContent = locker.person_in_charge_fin;
                document.getElementById('viewPersonPhone').textContent = locker.person_in_charge_phone || 'Not provided';
                document.getElementById('viewPersonCompany').textContent = locker.person_in_charge_company || 'Not provided';
                document.getElementById('viewOeDcName').textContent = locker.oe_dc_name || 'Unknown';
                document.getElementById('viewStatus').textContent = locker.status;
                document.getElementById('viewNotes').textContent = locker.notes || 'No notes';
                document.getElementById('viewCreatedAt').textContent = locker.created_at;
                
                // Signature status
                document.getElementById('viewTenantSignature').textContent = locker.tenant_signature ? 'Signed' : 'Pending';
                document.getElementById('viewTenantSignatureDate').textContent = locker.tenant_signature_date || 'Not signed';
                document.getElementById('viewOeDcSignature').textContent = locker.oe_dc_signature ? 'Signed' : 'Pending';
                document.getElementById('viewOeDcSignatureDate').textContent = locker.oe_dc_signature_date || 'Not signed';
                
                // Room assignments
                const roomsContainer = document.getElementById('viewRoomAssignments');
                roomsContainer.innerHTML = '';
                
                if (locker.room_assignments && locker.room_assignments.length > 0) {
                    const activeRooms = locker.room_assignments.filter(r => r.is_active);
                    const inactiveRooms = locker.room_assignments.filter(r => !r.is_active);
                    
                    if (activeRooms.length > 0) {
                        roomsContainer.innerHTML += `<div class="mb-2"><strong>Active Rooms:</strong> ${activeRooms.map(r => r.room_number).join(', ')}</div>`;
                    }
                    if (inactiveRooms.length > 0) {
                        roomsContainer.innerHTML += `<div class="mb-2"><strong>Inactive Rooms:</strong> ${inactiveRooms.map(r => r.room_number).join(', ')}</div>`;
                    }
                    roomsContainer.innerHTML += `<div><strong>Total Active Rooms:</strong> ${activeRooms.length}</div>`;
                } else {
                    roomsContainer.innerHTML = '<em>No room assignments</em>';
                }
                
                // Show modal
                new bootstrap.Modal(document.getElementById('viewFoodLockerModal')).show();
            } else {
                alert('Error loading food locker details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading food locker details');
        });
}

function editFoodLocker(id) {
    // Add edit functionality - you can implement a modal or redirect to edit page
    alert('Edit functionality for Food Locker ID: ' + id + ' can be implemented here');
}
</script>

<!-- Include Signature Pad library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
{% endblock %}